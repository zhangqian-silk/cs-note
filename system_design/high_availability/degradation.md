# Degradation

服务降级是分布式系统在高并发、资源不足或依赖服务故障时，为保证核心功能可用性而采取的**策略性妥协**，侧重于从全局视角考虑，其目标如下：

- **核心保障**：优先保障核心业务链路
- **及时恢复**：降级后能及时感知可恢复时机，并自动 / 手动恢复

## 设计原则

- **核心与非核心分离**：通过微服务拆分明确核心服务边界（如订单服务 vs 积分服务）
- **降级兜底数据**：提前准备静态数据、默认值或缓存热数据
- **用户体验平滑**：降级时提示“部分功能暂不可用”，而非直接报错
- **可监控可恢复**：实时监控降级状态，故障恢复后自动检测并回滚

## 降级方案

### 触发方式分类

**手动降级**  

- **场景**：预知的高流量（如大促、春节）、人工介入紧急情况
- **实现**：通过配置中心动态关闭非核心功能，或调整限流大小
- **示例**：关闭商品评价、推荐列表，保留购物车和支付

**自动降级**

- **场景**：系统自动检测到异常（如超时、错误率飙升）
- **实现**：结合熔断器设置阈值规则
- **示例**：依赖的积分服务故障时，自动跳过积分抵扣逻辑

### 功能层面分类

**读服务降级**

- 返回缓存数据：如商品详情页降级到本地缓存或静态数据
- 精简数据字段：仅返回核心字段（如价格、库存），隐藏详情描述

**写服务降级**

- 异步化处理：将非实时操作异步化（如订单成功后异步发送通知）
- 简化流程：跳过次要校验（如风控校验降级为简单规则）

**依赖服务降级**

- 熔断依赖：通过熔断器快速失败，避免线程池耗尽
- 静态兜底：返回预设默认值

### 降级策略分类

**限流降级**

- 触发限流时，拒绝部分请求并返回友好提示（“系统繁忙，请重试”）

**功能开关**

- 代码中预埋开关，动态关闭非关键功能模块，如关闭个性化推荐，改为返回通用列表

**弹性超时**  

- 动态调整超时时间，避免线程长时间阻塞。例如，正常超时 2s，降级时缩短为 500ms

**服务权重调整**  

- 在负载均衡层降低某节点的流量权重，或将请求导向备份服务

## Ref

- <https://zhuanlan.zhihu.com/p/608422702>
