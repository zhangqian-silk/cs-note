# Load Balancing

负载均衡（Load Balancing）是一种将网络流量或计算任务分配到多个服务器或资源的策略，旨在优化资源使用、提升系统性能、避免单点故障，用于解决高可用问题。

## 负载均衡类型

### 服务端负载均衡

负载均衡的逻辑由独立的中间件（如 Nginx、负载均衡器）实现，客户端将请求发送到负载均衡中间件，由中间件决定转发到哪个服务节点，主要用于传统 Web 架构中。

**按协议层划分**

- **四层负载均衡（L4）**：基于传输层（TCP/UDP）信息（如 IP 和端口）分配流量
  **示例工具**：LVS（Linux Virtual Server）、F5 BIG-IP
- **七层负载均衡（L7）**：基于应用层协议（如 HTTP、HTTPS）内容（URL、Cookie 等）进行路由
  **示例工具**：Nginx、HAProxy、AWS ALB

**按部署位置划分**

- **硬件负载均衡器**：专用设备（如F5、Citrix NetScaler），高性能但成本高
- **软件负载均衡器**：基于软件的解决方案（如 Nginx、Traefik），灵活且适合云环境

### 客户端负载均衡

负载均衡的逻辑由客户端（或应用自身）实现，客户端维护一份目标服务器地址列表，直接决定将请求发送到哪个服务节点，主要用于微服务架构中，服务内部通信使用，目标服务器地址可通过注册中心获取。

## 负载均衡算法

**随机 & 轮询**

按照概率或顺序分配请求，适合服务器性能相近的场景，可叠加**加权**和**粘性**策略。

- **加权**：根据服务器性能分配权重，高性能服务器处理更多请求
- **粘性**：优先保障同一个客户端的请求，发送至同一个服务器上，利用服务器的内存缓存

**哈希**

对 IP 或 URL 或特定参数取哈希值，根据哈希结果选择服务器。

在服务器数量不变，且用户请求时哈希的入参不变（如 IP），可以保障哈希结果的唯一性，并再每次请求时，都访问同一个服务器。

通过一致性哈希替代普通哈希，可以在服务器数量动态变化时，仅影响存在变更的服务器，而不影响其他服务器。

**最少链接**

每次请求时，遍历服务器列表，选择当前连接数量最小的一台服务器，能够实现动态负载均衡。当连接数量相等时，可使用随机、加权随机等方案进行二次选择。

其核心是选择当前负载最小的服务器，除了连接数，还可以将活跃连接数（当前正在处理的请求数）、机器 CPU & 内存负载等其他指标，作为判断依据。

**响应时间**

维护服务器响应时间映射表，每次请求选择平均响应时间最短的服务器，目标是使的请求被更快的处理，但是会导致流量集中于高性能服务器。

计算平均响应时间时，可采用加权平均进行计算，权重可考虑随时间线性衰减或指数衰减。

## 实现方案

### DNS

DNS 是早期的七层负载均衡的实现方式，通过 DNS 解析将域名映射到多个 IP 地址，从而将用户请求分散到不同服务器，如 CDN。

常见策略如下：

- **轮询**：DNS 服务器依次返回不同的 IP 地址
- **权重轮询**：基于权重进行轮询
- **基于地理位置的解析**：根据用户地理位置返回最近的服务器 IP
- **故障转移**：当主服务器不可用时，自动切换到备用服务器

### 反向代理

反向代理（Reverse Proxy）服务器接收客户端请求，根据负载均衡算法将请求转发到后端服务器集群，如 Nginx。

反向代理指的是用反向代理服务器来代理真实服务器，对用户隐藏真实服务器的细节信息。

### 读写分离

将数据库的读操作与写操作进行分离，写操作访问主库，读操作访问从库，实现方案如下：

- **主从复制**：数据库支持绑定主从关系，自动执行主从复制逻辑
- **代理**：由 ORM 框架负责根据读写操作，执行负载均衡策略

### 微服务

微服务间访问时，由 RPC 框架或 Mesh 的 SideCar 代理，实现客户端负载均衡。

## Ref

- [wiki/负载均衡](https://zh.wikipedia.org/wiki/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1)
- <https://javaguide.cn/high-performance/load-balancing.html>
