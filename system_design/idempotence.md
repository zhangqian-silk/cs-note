# idempotence

幂等性（idempotence）是数学与计算机中的一个概念，指的是一个操作进行多次的结果，均与第一次结果一致。

对于接口来说，以相同的参数调用特定接口一次或多次时，对系统产生的影响是相同的，那就认为接口是幂等的。

## 幂等场景

**网络异常**

- **客户端超时重试**：客户端调用接口后未及时收到响应（如网络抖动、服务端处理慢），触发自动重试机制
- **服务端响应丢失**：服务端处理成功但响应未到达客户端（如TCP连接断开），客户端重新发起请求

**用户行为**

- **前端未防重**：用户短时间内多次点击按钮（如提交订单、支付），前端未做防重拦截
- **浏览器/App后退刷新**：用户提交表单后，通过浏览器后退或App返回上一页再次提交

**消息中间件重复消费**

- **消息队列重试机制**：消息队列（如Kafka、RocketMQ）的 **at-least-once** 投递语义可能导致消息重复消费
- **消费者处理失败重试**：消费者处理消息时发生临时错误（如数据库连接超时），触发消息重试

**分布式系统容错机制**

- **分布式事务补偿**：在分布式事务（如Saga模式）中，因部分服务失败触发事务补偿，可能重复执行补偿操作
- **服务熔断后重试**：服务熔断恢复后，客户端重新发起失败请求

**定时任务**

- **任务调度器漂移**：分布式定时任务因节点时间不同步或负载均衡漂移，导致同一任务多次触发
- **任务执行超时重复触发**：任务执行时间过长，被调度系统判定为超时失败，触发重新执行

**三方服务异常**

- **第三方回调重复通知**：第三方平台因网络问题多次发送同一笔支付结果回调
- **客户端SDK自动重试**：集成第三方SDK（如云存储上传）时，SDK内部因错误自动重试

**数据库**

- **唯一索引冲突重试**：插入数据时因唯一索引冲突，业务代码尝试修改后重新插入
- **主从同步延迟**：读写分离架构下，写操作后立即读从库，因主从延迟导致读取旧数据，误判为未处理
- **缓存击穿后重试**：高并发下缓存击穿，多个请求穿透到数据库，导致重复查询或更新

## 幂等方案

**客户端幂等**

- **原理**：防止用户多次触发
- **步骤**：
  - 用户点击按钮后，将按钮置灰，或显示 loading
  - 用户提交表单后，重定向至提及成功页面，避免用户刷新或回退后，重复提交
- **适用场景**：与用户操作强相关的业务

**唯一标识符**（IDEMPOTENT KEY）

- **原理**：客户端生成唯一请求ID，服务端校验是否已处理
- **步骤**：
  - 客户端生成唯一ID（如UUID、雪花算法ID），随请求发送
  - 服务端通过数据库或 Redis 检查该 ID 是否存在：
    - 存在：返回已处理结果
    - 不存在：执行业务逻辑，记录ID到数据库/Redis（设置过期时间）
- **适用场景**：支付、订单创建等需严格防重的接口

**数据库唯一索引**

- **原理**：利用数据库唯一约束防止重复数据插入
- **步骤**：
  - 设计表时，对业务唯一字段（如订单号）添加唯一索引
  - 插入数据时捕获异常，转为幂等响应
- **适用场景**：创建唯一资源的场景（如订单号、流水号）

**Token（防重令牌）**

- **原理**：服务端预生成 Token，客户端提交时携带并验证
- **步骤**：
  - 客户端先请求获取 Token（如提交订单前调用获取 Token 的接口）
  - 服务端生成 Token 并存储到 Redis（设置较短过期时间）
  - 客户端携带 Token 提交业务请求，服务端校验后删除 Token
  - 重复请求因 Token 不存在而被拒绝。
- **适用场景**：前端页面防重复提交（如提交表单、支付）

**状态机**

- **原理**：业务状态流转时，拒绝非法状态变更
- **步骤**：
  - 设计业务状态机（如订单状态：未支付 → 已支付 → 已完成）
  - 更新数据时检查当前状态是否允许变更
- **适用场景**：订单状态更新、流程审批等

**分布式锁**

- **原理**：对关键操作加锁，防止分布式场景下并发执行
- **步骤**：
  1. 使用Redis或ZooKeeper实现分布式锁
  2. 操作前加锁，执行后释放锁
- **适用场景**：分布式环境下的并发控制（如库存扣减）

**版本号/乐观锁**

- **原理**：通过数据版本号控制并发更新
- **步骤**：
  - 数据表中增加版本号字段（`version`）
  - 更新时校验版本号是否匹配
- **适用场景**：数据更新操作（如账户余额修改）

## Ref

- [wiki/Idempotence](https://en.wikipedia.org/wiki/Idempotence)
- <https://juejin.cn/post/7098355055610298404>
