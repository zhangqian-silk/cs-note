# Persistence

Redis 中数据持久化方案分为两种：

- RDB(Redis Database)：定期存储内存中的数据快照，恢复时直接将二进制数据加载进内存
- AOF(Append Only File)：存储 Redis 的写操作日志，恢复时按照指定顺序重新执行

最终的持久化策略，自然也可以分为四种：

- 不启用持久化方案
- 启用 RDB
- 启用 AOF
- 启用 RDB 与 AOF 的混合方案

用户需要根据业务特性，做对应的选择。

## RDB

RDB 方案会存储当前内存中的全量数据的快照，一般仅在子线程中执行，避免阻塞主线程。为了加快子线程的创建，对于共享内存采用了写时复制([copy-on-write](https://zh.wikipedia.org/wiki/%E5%AF%AB%E5%85%A5%E6%99%82%E8%A4%87%E8%A3%BD))的方案，所有读操作共同使用一份副本文件，当有写操作发生时，单独将这部分内存复制一份，用于修改。

RDB 的执行时机可以设置多个检查点，比如间隔 5 分钟，或是新增了 100 条写入操作

- 执行间隔长，一般会增加数据丢失时的数据量
- 执行间隔短，会频繁触发创建子线程的操作，增加 CPU 开销

RDB 方案的优缺点如下所示：

- 优点

  - 方便进行数据恢复，有利于故障重启、备份恢复、数据迁移等场景
  - 不同备份文件间可用来对比版本差异
  - 性能高，主线程仅负责创建子线程，耗时的 IO 操作由子线程执行

- 缺点

  - 写时复制会增加内存占用，极端情况会导致内存占用翻倍
  - 快照仅会记录某一个特定时间点的数据，在下次执行前会存在数据丢失风险

## AOF

AOF 方案会针对于写操作，在执行完命令之后，将该命令追加至缓冲区中，然后通过 `write()` 函数，将缓冲区的数据写入内核缓冲区，由内核控制将缓冲区数据写入硬盘中。

在将数据最终从内核缓冲区写入硬盘时，由三种策略可供选择，同样需要在性能与数据丢失间做抉择：

- Always 策略：每次执行写操作命令时，同步将命令写入硬盘中的日志文件
- Everysec 策略：每次执行完写操作命令时，仅将命令写入内核缓冲区，每秒定时将缓冲区中数据写入硬盘
- No 策略：交由系统控制写回硬盘的时机

AOF 方案优缺点如下所示：

- 优点

  - 数据丢失最小，根据文件同步的策略，最多也仅会丢失秒级别的数据
  - 对于日志以 append 的方式写入，写入新操作出现异常时，不会影响历史数据
  - 可以通过重写等方案减少日志文件大小，且安全性高
  - 日志文件记录了所有操作步骤，格式简单，可以自定义修改
    - 例如误执行 `FLUSHALL` 操作，可以在重建时仅从操作日志中移除该条操作

- 缺点

  - AOF 文件占用通常要大于 RDB 文件
  - 在恢复数据时，要顺序执行日志中的所有命令，性能也会更差一些
  - 在执行命令时，因为要同步将命令写入日志文件中，所以性能要比 RDB 差一些

## Ref

- <https://redis.io/docs/latest/operate/oss_and_stack/management/persistence/>
- <https://xiaolincoding.com/redis/storage/aof.html>
- <https://xiaolincoding.com/redis/storage/rdb.html>
