# Sharding

MySQL 的分库分表（Sharding）是一种常见的数据库水平扩展方案，用于解决单库单表数据量过大、读写性能瓶颈以及存储容量限制等问题。其核心逻辑是将数据分散到多个数据库或表中，降低单个节点的压力。

## 核心概念

**分库**  

将数据按规则拆分到多个独立的数据库中，每个数据库可以部署在不同服务器上（物理分库），实现负载均衡和资源隔离。

- **垂直分库**：把单一数据库按照业务维度划分，不同业务使用不通的数据库，如用户表、订单表、商品表拆分至单独的数据库
- **水平分库**：把同一个表按照分片规则，如日期，拆分到不通的数据库中

**分表**

将单表数据按规则拆分到多个表中，可以分散在同一个库中（逻辑分表）或不同库中（物理分表）。

- **垂直分表**：将大表的某些列拆分到独立的表中，减少单表宽度，例如将高频查询的字段和低频字段分离
- **水平分表**：把一张行比较大的表拆分为多张表，一般与**水平分库**同时使用

## 分片策略

- **范围分片**：按时间范围（如按月分表）或 ID 范围（如 `user_id` 在 1-1000 存入表 1）
- **哈希分片**：通过哈希算法（如 `user_id % N`）均匀分布数据
- **一致性哈希**：减少节点扩容时的数据迁移量
- **地理位置分片**：按用户地域分布数据

## 实现方式

**客户端分片（应用层分片）**

- **逻辑在应用代码中实现**：通过编程决定数据读写哪个库/表
- **优点**：灵活可控，无额外依赖
- **缺点**：代码侵入性强，维护复杂
- **工具示例**：MyBatis 插件、Spring 动态数据源

**中间件分片**

- **代理中间件**：在应用和数据库之间添加代理层（如 MyCat、ShardingSphere-Proxy），自动路由请求
- **嵌入式中间件**：以 SDK 形式嵌入应用（如 Apache ShardingSphere-JDBC）
- **优点**：对业务代码透明，支持动态扩容
- **缺点**：引入额外组件，可能成为性能瓶颈

## 核心问题

**分布式事务**

- **问题**：跨库操作难以保证事务一致性
- **解决方案**：
  - 使用柔性事务（如 TCC、Saga）
  - 基于消息队列的最终一致性（如 RocketMQ 事务消息）

**跨库查询（JOIN）**

- **问题**：数据分散后难以执行跨库关联查询
- **解决方案**：
  - 避免跨库 JOIN，通过冗余字段或业务层聚合数据
  - 使用全局表（广播表）存储公共数据（如配置表）

**全局唯一主键**

- **问题**：分片后自增ID可能重复
- **解决方案**：
  - Snowflake 算法生成分布式ID
  - Redis 自增或数据库分段分配

**扩容与数据迁移**

- **问题**：增加分片数量时需重新分布数据
- **解决方案**：
  - 预分片（如一次性分为 1024 个逻辑表）
  - 使用一致性哈希减少数据迁移量

## Ref

- <https://javaguide.cn/high-performance/read-and-write-separation-and-library-subtable.html>
