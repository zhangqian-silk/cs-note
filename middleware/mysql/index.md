# Index

## 数据结构

InnoDB 中，索引默认使用 **B+Tree** 实现，数中每一个节点对应一个数据页或索引页，其结构如下所示：

<div style="display: flex; justify-content: space-around; align-items: center;">
  <img src="images/2025-03-11-23-17-29.png" style="width: 30%; height: auto; object-fit: cover;" />
  <img src="images/2025-03-11-23-17-33.png" style="width: 58%; height: auto; object-fit: cover;" />
</div>
<br>

同层节点间按照索引键排序，构成双向链表，方便范围查询。

![](images/2025-03-11-23-30-10.png)

在具体实现上，分为聚簇索引和非聚簇索引，其中聚簇索引会使用主键作为索引键，其他索引如普通索引、唯一索引、前缀索引、联合索引等，都为非聚簇索引，也称二级索引。

不存在主键时，会选择第一个非空且值唯一的列作为聚簇索引的键，如果也不存在，则会自动生成一个自增的隐藏列来作为聚簇索引的索引键。

其结构差异如下所示：

**聚簇索引（主键索引）**

- 叶子节点存储索引值和实际数据
- 非叶子节点存储索引值和子节点指针

![](images/2025-03-11-22-58-21.png)

**非聚簇索引（二级索引）**

- 叶子节点存储索引值和主键值
- 非叶子节点存储索引值和子节点指针
- **回表**：在获取实际数据时，需要通过主键值再进行查找

![](images/2025-03-11-22-58-27.png)

### 存储容量

假定主键和子节点指针共占用 16 字节，一行数据约为 1024 字节，忽略页内其他数据，如文件头、页头、文件尾等，此时，其存储容量计算如下：

- **索引页**：约为 $16KB / 16Byte = 1024 条$
- **数据页**：约为 $16KB / 1Byte = 16 条$
- **3 层容量**：约为 $1024 * 1024 * 16 \approx 1600万条$
- **4 层容量**：约为 $1024 * 1024 * 1024 * 16 \approx 160亿条$

## 索引维护

### 页分裂 & 页合并

B+Tree 在插入新数据时，必须保障整体仍然是有序的。如果向一个已满的索引页中插入，则会触发页分裂，并将原本索引页中的部分数据迁移至新的索引页中，并更新相关的指针信息。

页分裂会带来如下问题：

- **性能开销**
  - 磁盘 I/O：涉及新页的分配、数据的迁移以及索引的更新
  - 锁竞争：分裂中需要加锁，可能会阻塞其他事务

- **存储碎片**
  - 分离后的两个页面均只有部分数据，空间利用率下降

- **树高度增长**
  - 若涉及到根节点分裂，则会导致 B+Tree 高度增加，影响后续所有查询

当更新或删除索引时，可能会导致已有的索引页空间利用率降低，当低于阈值时，InnoDB 会尝试将相邻的页进行合并，减小碎片，释放空间，但是仍会带来额外的性能开销。

### 自增主键

在设置聚簇索引的索引键时，如果是分布式场景，则需要额外考虑分布式 ID 的生成方案，例如 Redis 原子递增或雪花 ID，其他场景下，则推荐使用自增主键，其优势如下所示：

**减少页分裂与页合并**

- 使用自增主键时，新数据总是追加到索引末尾的页中，避免了插入随机位置导致的页分裂
- 主键只能自增，不允许修改，同样也减少了页合并的频率

**写入性能优化**

- 自增主键能够保障插入时会按照顺序插入，相较于随机写入，磁盘寻道效率更高（快 10~100 倍）

**空间利用率高**

- 顺序写入在减少页分裂的同时，也显著减少了空间碎片的数量，提供空间利用率

**空间占用小**

- 使用自增索引时，Bigint 一般即可满足使用诉求，通常为 8 字节，相比与 UUID、哈希值或其他业务数据，占用空间更小
- 针对于二级索引，其叶子节点占用空间也更小
- 空间占用小整体会使得 B+Tree 高度降低，提高查询效率

**事务并发**

- 自增主键的顺序写入，会减少行级锁的竞争

### 索引的选择

- 优先选择频繁查询的字段，提高利用率
- 优先选择经常用来做等值匹配的字段，提高命中率
- 优先选择需要排序的字段，可以直接利用索引的排序
- 优先选择连表查询的字段，提高连接效率
- 尽量建立联合索引，而不是单列索引
- 尽量避免频繁更新的字段，减少索引的维护成本
- 尽量避免重复值较多的字段，其索引效果较差
- 限制索引的数量，降低维护成本，加快优化器的索引选择效率

## 优化策略

### 覆盖索引

### 索引下推

### 最左匹配

### 前缀索引

## 索引失效

## Ref

- <https://xiaolincoding.com/mysql/index/index_interview.html>
- <https://javaguide.cn/database/mysql/mysql-index.html>
- <https://jums.gitbook.io/mysql-shi-zhan-45-jiang/04-shen-ru-qian-chu-suo-yin-shang>
- <https://xiaolincoding.com/mysql/index/page.html#>
