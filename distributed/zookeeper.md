# ZooKeeper

ZooKeeper 是一个开源的分布式协调服务框架，即为分布式应用提供一致性服务，最初是 Apache Hadoop 项目的一个子项目，后来发展成为一个独立的顶级项目。

在架构上，通过集群部署，提供了高可用、高并发，并定制了 ZAB（ZooKeeper Atomic Broadcast） 协议，用于解决分布式场景下，主从之间的数据一致性问题。与此同时，结合 Zxid 确保顺序一致性，结合 WAL(Write-Ahead Log) 与快照能力，确保持久性。

## 核心特性

**一致性**

保障顺序一致性和数据一致性，来自任何特定客户端的更新请求都会按照其发送顺序被应用，同时所有服务器上的数据是最终一致的。

主要机制：

- Zxid：保障操作的顺序
- ZAB 协议：保障数据一致性

**持久性 (Durability)**

一旦一个更新操作被成功应用并得到确认，这个状态变化就会被持久化，即使发生服务器故障也不会丢失。

主要机制：

- WAL: 日志先行，所有确认的变更都会先持久化存储
- 定期快照: 定期将内存中的数据树状态完整地转储到磁盘快照文件中
- 数据恢复: 当服务器启动或从故障中恢复时，它会先加载最新的快照，然后重放快照之后的所有事务日志，从而恢复到最新的状态

**原子性 (Atomicity)**

更新操作要么完全成功，要么完全失败，不存在部分成功的情况。

主要机制：

- 一致性：保障数据一致性
- 持久性：保障服务器意外退出后，也能恢复所有已确认的变更
- `multi` 操作：将多个操作视为一个原子操作

**高可用性**

ZooKeeper 集群只要有超过半数的服务器正常工作，整个服务就是可用的。

主要机制：

- Replication: 多个服务器中的数据是一致的，均可对外提供服务
- ZAB 协议: 超过半数服务器时，可完成选举、投票等操作

## 数据模型

ZooKeeper 的数据模型是一个**层次化的命名空间（hierarchical namespace）**，其结构与标准文件系统非常相似，这个命名空间由一系列的 **ZNode** (ZooKeeper Node) 组成。

![](https://oss.javaguide.cn/p3-juejin/663240470d524dd4ac6e68bde0b666eb~tplv-k3u1fbpfcp-zoom-1.jpeg)

核心要点如下：

- **不是通用数据库：** 不要用来存储大量应用数据，强项在于协调和元数据管理
- **内存为主，持久化为辅：** 为了高性能，数据主要存储在内存中，但会通过事务日志和快照持久化到磁盘，实现持久化
- **版本号：** `Stat` 中的 `version` (数据版本) 和 `cversion` (子节点版本) 对于实现乐观并发控制非常重
- **临时节点：** 临时节点是实现许多分布式协调模式（如服务发现、活性检测、分布式锁）的关键
- **顺序节点：** 顺序节点为实现公平锁、分布式队列等提供了便利

### ZNode (ZooKeeper 节点)

**路径 (Path)**

每个 ZNode 都通过一个唯一的、以 `/` 分隔的路径来标识，类似于文件系统中的文件路径

- 路径必须是绝对路径，以 `/` 开头
- 路径中不能包含 `.` 或 `..` 这样的相对路径元素
- 路径的组成部分不能包含 `/` 字符本身

**数据 (Data)**

每个 ZNode 都可以存储少量数据（通常是配置信息、状态信息、元数据等）

- 数据是以字节数组 (`byte[]`) 的形式存储的
- ZooKeeper 不会解析或关心这些数据的具体内容，它只负责存储和检索
- ZNode 存储的数据量默认上限是 1MB，应该仅存储少量的、关键的用于协调的数据

**子节点 (Children)**

ZNode 可以有子节点，从而形成树状结构

- 一个 ZNode 可以同时拥有数据和子节点

**Stat 结构 (Metadata)**

每个 ZNode 都关联一个 `Stat` 对象，它包含了该 ZNode 的元数据信息

- `cZxid`: 创建该 ZNode 的事务 ID，由 epoch (纪元号，每次选举新的 Leader 时递增) 和 counter (该 epoch 内的事务计数器)两部分组成
- `mZxid`: 最后一次修改该 ZNode 的事务 ID
- `pZxid`: 最后一次修改该 ZNode 的子节点列表的事务 ID
- `ctime`: ZNode 的创建时间 (毫秒)
- `mtime`: ZNode 的最后修改时间 (毫秒)
- `dataVersion`: ZNode 数据内容的版本号。每次数据修改，版本号都会增加，用于乐观锁
- `cversion`: ZNode 子节点的版本号。每次子节点列表（增删子节点）发生变化，版本号都会增加
- `aclVersion`: ZNode ACL (访问控制列表) 的版本号
- `ephemeralOwner`: 如果该 ZNode 是临时节点，则此字段为创建该节点的会话 ID (Session ID)，如果不是临时节点，则为 0
- `dataLength`: ZNode 数据内容的长度
- `numChildren`: 该 ZNode 的子节点数量

### ZNode 类型

ZooKeeper 中的 ZNode 有多种类型，这些类型决定了 ZNode 的生命周期和行为：

**持久节点 (Persistent Nodes)**

- 默认的节点类型，一旦创建，除非被显式删除，否则会一直存在
- 生命周期与创建节点的客户端会话无关
- 用途：存储需要长期存在的配置信息、应用元数据等

**临时节点 (Ephemeral Nodes)**

- 生命周期与创建它的客户端会话绑定，会话结束时，会自动删除
- **重要特性：临时节点只能做叶子节点，不能有子节点**
- 用途：适合实现服务发现（服务提供者注册一个临时节点，服务消费者监听）、集群成员管理（每个成员注册一个临时节点）、领导者选举（竞争创建临时节点）、分布式锁（创建临时节点表示持有锁）

**顺序节点 (Sequential Nodes)**

- 当创建这类节点时，ZooKeeper 会自动在指定的路径名后附加一个单调递增的 10 位数字序号
- 顺序节点可以是持久节点或临时节点
- 例如，如果客户端请求创建路径为 `/myapp/lock-` 的顺序节点，ZooKeeper 可能会创建 `/myapp/lock-0000000001`，下一个可能是 `/myapp/lock-0000000002`，以此类推
- 这个序号在父节点的所有子节点中是唯一的且单调递增的
- 用途：常用于实现分布式锁（特别是公平锁，序号最小的获得锁）、分布式队列、唯一命名等

**容器节点 (Container Nodes) (自 ZooKeeper 3.5.3 版本引入)**

- 一种特殊的持久节点
- 当一个容器节点的最后一个子节点被删除后，该容器节点本身将在未来的某个时刻（不是立即）被 ZooKeeper 服务器自动删除
- 用途：用于管理那些作为父节点但本身不存储重要数据，只用于组织子节点的 ZNode，当子节点都被清理后，这些父节点可以被自动清理，避免留下大量空的父节点

**TTL 节点 (TTL Nodes) (自 ZooKeeper 3.5.3 版本引入)**

- 可以为持久节点设置一个 TTL (Time To Live) 值（以毫秒为单位）
- 如果一个 TTL 节点在 TTL 时间内没有被修改，并且没有任何子节点，那么它将被 ZooKeeper 服务器自动删除
- 用途：用于自动清理过期的、不再使用的数据，例如一些有时效性的状态信息

## Ref

- <https://zh.wikipedia.org/zh-hans/Apache_ZooKeeper>
- <https://javaguide.cn/distributed-system/distributed-process-coordination/zookeeper/zookeeper-intro.html>
- <https://javaguide.cn/distributed-system/distributed-process-coordination/zookeeper/zookeeper-plus.html>
