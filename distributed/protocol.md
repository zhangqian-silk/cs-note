# 分布式协议

分布式系统中常见的协议主要用于解决一致性、共识、事务处理等问题。

协议是节点间通信的规则，用于实现某种理论或机制。

- 一致性协议
  - Paxos：解决分布式系统如何就某个值达成一致（如 Chubby）。
  - Raft：简化版 Paxos，通过 Leader 选举和日志复制实现一致性（如 etcd）。
  - ZAB：ZooKeeper 的原子广播协议，用于主从节点同步。
- 事务协议
  - 2PC（两阶段提交）：协调者分两阶段协调事务提交，但存在阻塞问题。
  - 3PC（三阶段提交）：在 2PC 基础上增加预提交阶段，降低阻塞概率。
- 共识协议
  - PBFT（拜占庭容错）：允许部分节点作恶时仍能达成共识（如区块链场景）。
  - PoW（工作量证明）：通过算力竞争达成共识（如比特币）。

以下是几种典型协议及其区别：

- Paxos
  - 用途：解决分布式系统中的共识问题（多个节点对某个值达成一致）。
  - 核心思想：通过两阶段（Prepare & Accept）实现多数派投票，容忍节点故障。
  - 特点：
    - 强一致性（所有节点最终达成相同状态）。
    - 允许部分节点失效（半数以下故障仍可用）。
    - 理论复杂，工程实现难度大。
  - 应用：Google Chubby、早期分布式系统。

- Raft
  - 用途：简化版的共识算法，目标比 Paxos 更易理解。
  - 核心思想：
    - 领导者（Leader）选举机制。
    - 日志复制（Log Replication）实现一致性。
  - 特点：
    - 强一致性。
    - 将流程分解为领导者选举、日志复制、安全性三个子问题。
    - 实现简单（如 etcd、Consul 使用 Raft）。
  - 与 Paxos 区别：
    - Raft 强调强领导者模型，而 Paxos 允许并行提交。
    - Raft 通过日志连续性简化状态管理。

- ZAB（ZooKeeper Atomic Broadcast）
  - 用途：ZooKeeper 的核心协议，用于实现原子广播和崩溃恢复。
  - 核心思想：
    - 类似 Raft 的领导者选举。
    - 两阶段提交（Broadcast + Commit）保证消息顺序。
  - 特点：
    - 保证全局有序的广播（所有操作按顺序执行）。
    - 适合协调服务（如分布式锁、配置管理）。
  - 与 Raft 区别：
    - ZAB 更关注消息顺序，而 Raft 更强调日志一致性。
    - ZAB 的恢复机制更复杂。

- 两阶段提交（2PC）
  - 用途：分布式事务的原子性（所有节点提交或回滚）。
  - 核心思想：
    - 阶段 1（Prepare）：协调者询问所有参与者是否可提交。
    - 阶段 2（Commit/Rollback）：根据参与者反馈决定提交或回滚。
  - 缺点：
    - 阻塞协议（协调者故障可能导致参与者阻塞）。
    - 无法容忍网络分区。
    - 应用场景：传统数据库分布式事务（如 XA 事务）。

- 三阶段提交（3PC）
  - 改进 2PC 的问题：
    - 引入超时机制，解决协调者故障导致的阻塞。
    - 新增Pre-Commit 阶段，减少参与者不确定性。
  - 缺点：
    - 依然无法完全解决网络分区问题。
    - 实现复杂度高于 2PC。

- Gossip 协议
  - 用途：最终一致性的分布式状态传播（如节点状态、元数据同步）。
  - 核心思想：节点随机选择其他节点传播信息，类似流行病传播。
  - 特点：
    - 最终一致性（不保证强一致）。
    - 高扩展性，适合大规模集群。
    - 容错性强（节点故障不影响传播）。
  - 应用：Cassandra、Consul 的健康检查。

- 对比总结

| 协议 | 一致性 | 容错能力 | 性能 | 复杂度 | 典型应用 |
| :-: | :-: | :-: | :-: | :-: | :-: | :-: |
| Paxos | 强一致 | 半数节点存活 | 中 | 高 | Chubby |
| Raft | 强一致 | 半数节点存活 | 中 | 中 | etcd, Consul |
| ZAB | 强一致 | 半数节点存活 | 中 | 中 | ZooKeeper |
| 2PC | 强一致 | 协调者单点故障 | 低 | 低 | 数据库分布式事务 |
| 3PC | 强一致 | 改进协调者问题 | 中低 | 中 | 较少使用 |
| Gossip | 最终一致 | 高容错 | 高 | 低 | Cassandra, 状态同步 |

- 选择依据
  - 强一致性需求：Paxos/Raft/ZAB。
  - 高可用与最终一致：Gossip。
  - 简单事务：2PC/3PC（注意其局限性）。
  - 协调服务：ZAB（ZooKeeper）、Raft（etcd）。
